# Testing

To make the library complete we should write some tests, but we have three independent implementations and it is a waste of time to write duplicate tests for each one.
The good thing about common code is that it can be covered with common tests, which later are compiled and executed on *every* platform.
All the bits for testing are already generated by the project Wizard.

Let's create the class `Base64Test` in `commonTest/kotlin/jetbrains/base64` folder and write the basic tests for Base64.

But as you remember, our API converts byte arrays to byte arrays in a different format and it is not easy to test byte arrays.
So before we start writing a test, let's add the method `encodeToString` with a default implementation to our `Base64Encoder` interface:

<div class="language-kotlin" markdown="1" mode="kotlin" theme="idea" data-highlight-only>

```kotlin
interface Base64Encoder {
    fun encode(src: ByteArray): ByteArray

    fun encodeToString(src: ByteArray): String {
        val encoded = encode(src)
        return buildString(encoded.size) {
            encoded.forEach { append(it.toChar()) }
        }
    }
}
```

</div>

Notice that the implementation on *every* platform can encode byte arrays to a string. If we want we can provide a more efficient implementation for this method, 
for example, let's specialize it on the JVM:

<div class="language-kotlin" markdown="1" mode="kotlin" theme="idea" data-highlight-only>

```kotlin
object JvmBase64Encoder : Base64Encoder {
    override fun encode(src: ByteArray): ByteArray = Base64.getEncoder().encode(src)
    override fun encodeToString(src: ByteArray): String = Base64.getEncoder().encodeToString(src)
}
```

</div>

Default implementations with optional more specialized overrides is another bonus of the multiplatform library. Now, when we have a string-based API, we can cover it with basic tests:

<div class="language-kotlin" markdown="1" mode="kotlin" theme="idea" data-highlight-only>

```kotlin
class Base64Test {
    @Test
    fun testEncodeToString() {
        checkEncodeToString("Kotlin is awesome", "S290bGluIGlzIGF3ZXNvbWU=")
    }

    @Test
    fun testPaddedStrings() {
        checkEncodeToString("", "")
        checkEncodeToString("1", "MQ==")
        checkEncodeToString("22", "MjI=")
        checkEncodeToString("333", "MzMz")
        checkEncodeToString("4444", "NDQ0NA==")
    }

    private fun checkEncodeToString(input: String, expectedOutput: String) {
        assertEquals(expectedOutput, Base64Factory.createEncoder().encodeToString(input.asciiToByteArray()))
    }

    private fun String.asciiToByteArray() = ByteArray(length) {
        get(it).toByte()
    }
}
```

</div>

Execute `./gradlew check` and you will see that the tests are run three times, on JVM, on JS, and on Native!

If we want, we can add tests to a specific platform, then it will be executed only as part of these platform tests.
For example, we can add UTF-16 tests on JVM. Just follow the same steps as before, but create file in `jvmTest/kotlin/jetbrains/base64`:

<div class="language-kotlin" markdown="1" mode="kotlin" theme="idea" data-highlight-only>

```kotlin
class Base64JvmTest {
    @Test
    fun testNonAsciiString() {
        val utf8String = "GÃ¶del"
        val actual = Base64Factory.createEncoder().encodeToString(utf8String.toByteArray())
        assertEquals("R8O2ZGVs", actual)
    }
}
```

</div>
This test will be automatically executed on the JVM target in addition to the common part.